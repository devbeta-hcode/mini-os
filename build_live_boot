#!/bin/bash

set -e

# YÃªu cáº§u quyá»n sudo náº¿u khÃ´ng pháº£i root
if [[ $EUID -ne 0 ]]; then
   echo "âš ï¸  This script must be run as root (sudo)" 
   exec sudo "$0" "$@"
   exit 1
fi

BUILD_DIR="build/live_boot"
CHROOT="build/chroot"
OUTPUT="releases/mini-os.iso"

# Gá»¡ mount cÃ²n tá»“n táº¡i
echo "ðŸ”„ Gá»¡ táº¥t cáº£ mount trong $CHROOT náº¿u cÃ²n..."
sudo mount | grep "$CHROOT" | awk '{print $3}' | sort -r | xargs -r sudo umount -lf

# táº£i nhá»¯ng thá»© sá»­a Ä‘á»•i vÃ o chroot
# bash start_mod

#cáº­p nháº­t láº¡i dns
cat > "$CHROOT/etc/resolv.conf" <<EOF
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

rm -rf $BUILD_DIR
mkdir -p $BUILD_DIR
mkdir -p $BUILD_DIR/live

# Copy kernel vÃ  initrd
cp -a $CHROOT/boot/vmlinuz-6.8.0-64-generic $BUILD_DIR/live/vmlinuz
cp -a $CHROOT/boot/initrd.img-6.8.0-64-generic $BUILD_DIR/live/initrd

# update menu GRUB
mkdir -p $BUILD_DIR/boot/grub
cp -a config/grub_live_boot.cfg $BUILD_DIR/boot/grub/grub.cfg

# pack squashfs
# bash clear_cache
echo "ðŸ”„ Ä‘ang nÃ©n $BUILD_DIR"
echo "ðŸ”„ Dung lÆ°á»£ng: $(du -sh $CHROOT)"
rm -rf $BUILD_DIR/live/filesystem.squashfs
mksquashfs $CHROOT $BUILD_DIR/live/filesystem.squashfs

# Build ISO boot
rm -rf $OUTPUT
grub-mkrescue -o $OUTPUT $BUILD_DIR --modules="linux normal iso9660 memdisk search tar ls" --xorriso=/usr/bin/xorriso

# dá»n dáº¹p
echo "ðŸ”„ dá»n dáº¹p thÆ° má»¥c $BUILD_DIR"
rm -rf $BUILD_DIR

echo "âœ… hoÃ n thÃ nh: $OUTPUT"


