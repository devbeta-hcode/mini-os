#!/bin/bash
# set -e

# YÃªu cáº§u quyá»n sudo náº¿u khÃ´ng pháº£i root
if [[ $EUID -ne 0 ]]; then
   echo "âš ï¸  This script must be run as root (sudo)" 
   exec sudo "$0" "$@"
   exit 1
fi

CHROOT="build/chroot"
echo "ðŸ§¹ Äang dá»n sáº¡ch chroot: $CHROOT"

# Gá»¡ mount cÃ²n tá»“n táº¡i
echo "ðŸ”„ Gá»¡ táº¥t cáº£ mount trong $CHROOT náº¿u cÃ²n..."
sudo mount | grep "$CHROOT" | awk '{print $3}' | sort -r | xargs -r sudo umount -lf

# cáº­p nháº­t láº¡i dns
cat > "$CHROOT/etc/resolv.conf" <<EOF
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

# Dá»n dáº¹p cÃ¡c vÃ¹ng khÃ´ng cáº§n thiáº¿t
sudo rm -rf $CHROOT/tmp/*
sudo rm -rf $CHROOT/var/tmp/*
sudo rm -rf $CHROOT/var/log/*
sudo rm -rf $CHROOT/var/log/journal/*
sudo rm -rf $CHROOT/var/cache/*
sudo rm -rf $CHROOT/var/spool/*
sudo rm -rf $CHROOT/var/mail/*
sudo rm -rf $CHROOT/var/backups/*
sudo rm -rf $CHROOT/var/opt/*
sudo rm -rf $CHROOT/var/local/*
sudo rm -rf $CHROOT/etc/cloud $CHROOT/var/lib/cloud $CHROOT/var/run/cloud-init
sudo rm -rf $CHROOT/var/log/cloud-init*
sudo rm -f $CHROOT/root/.bash_history
sudo rm -f $CHROOT/home/*/.bash_history

# Dá»n PID/socket
sudo find $CHROOT/var/lock -type f -delete
sudo find $CHROOT/var/run -name '*.pid' -delete
sudo find $CHROOT/var/run -name '*.lock' -delete

# Táº¡o láº¡i cáº¥u trÃºc thÆ° má»¥c thiáº¿t yáº¿u
echo "ðŸ§± Táº¡o láº¡i cáº¥u trÃºc /var tá»‘i thiá»ƒu..."
sudo mkdir -p $CHROOT/var/{cache,lib,log,mail,opt,spool,tmp,local,backups}
sudo mkdir -p $CHROOT/var/run
sudo mkdir -p $CHROOT/var/lock
sudo chmod 1777 $CHROOT/var/tmp
sudo chmod 1777 $CHROOT/var/lock
[ -L "$CHROOT/var/run" ] || sudo ln -sf /run $CHROOT/var/run
[ -L "$CHROOT/var/lock" ] || sudo ln -sf /run/lock $CHROOT/var/lock

# Cho dpkg vÃ  apt náº¿u cáº§n
sudo mkdir -p $CHROOT/var/lib/dpkg
sudo mkdir -p $CHROOT/var/lib/apt/lists
sudo mkdir -p $CHROOT/var/lib/systemd
sudo mkdir -p $CHROOT/var/lib/landscape
sudo touch $CHROOT/var/lib/dpkg/status
sudo touch $CHROOT/var/lib/dpkg/available

echo "âœ… Dá»n sáº¡ch vÃ  tÃ¡i táº¡o chroot xong!"
